# Apple JWT Auto-Regeneration System

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Apple Client Secret JWT –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ CI/CD pipeline –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è JWT
- ‚úÖ –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—é JWT –∑–∞ 30 –¥–Ω–µ–π –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è
- ‚úÖ Email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `.env` —Ñ–∞–π–ª–∞
- ‚úÖ –ë–µ—Å—à–æ–≤–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Docker

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ CI Pipeline

–ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ `ci.sh`:
```bash
echo "üîê Checking Apple JWT expiration..."
node scripts/check-apple-jwt.js
```

### 2. –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏

–°–∫—Ä–∏–ø—Ç `check-apple-jwt.js` –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
1. –ß–∏—Ç–∞–µ—Ç —Ç–µ–∫—É—â–∏–π JWT –∏–∑ `.env` —Ñ–∞–π–ª–∞ (`APPLE_CLIENT_SECRET_JWT`)
2. –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç JWT –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–∞—Ç—É –∏—Å—Ç–µ—á–µ–Ω–∏—è
3. –ï—Å–ª–∏ JWT –∏—Å—Ç–µ–∫–∞–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π:
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π JWT –∏–∑ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ (`APPLE_CLIENT_SECRET`)
   - –û–±–Ω–æ–≤–ª—è–µ—Ç `.env` —Ñ–∞–π–ª —Å –Ω–æ–≤—ã–º JWT
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–¥ –≤—ã—Ö–æ–¥–∞ `2`

### 3. Email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

–ü—Ä–∏ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ JWT –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫—Ä–∞—Å–∏–≤–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω–æ–µ email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ `quailbreeding@gmail.com` —Å:
- –î–∞—Ç–æ–π –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ JWT
- –î–∞—Ç–æ–π –∏—Å—Ç–µ—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ JWT
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–µ

## –ö–æ–¥—ã –≤—ã—Ö–æ–¥–∞

- `0` - JWT –≤–∞–ª–∏–¥–µ–Ω, –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
- `1` - –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ
- `2` - JWT –±—ã–ª —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω (`.env` –æ–±–Ω–æ–≤–ª—ë–Ω)

## –†—É—á–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å JWT (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
```bash
node scripts/check-apple-jwt.js
```

### –¢–æ–ª—å–∫–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π JWT (—Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥)
```bash
node scripts/generate-apple-secret.js
```

### –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```bash
node scripts/send-jwt-notification.js "2025-01-15T00:00:00Z" "2025-07-15T00:00:00Z"
```

## –¢—Ä–µ–±—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í `.env` —Ñ–∞–π–ª–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:
```env
# Apple OAuth Configuration
APPLE_TEAM_ID=ABC123XYZ
APPLE_CLIENT_ID=com.example.app
APPLE_KEY_ID=XYZ123ABC
APPLE_CLIENT_SECRET="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----"
APPLE_CLIENT_SECRET_JWT="eyJhbGc..."

# SMTP –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
SMTP_HOST=localhost
SMTP_PORT=587
SMTP_USER=your-email
SMTP_PASSWORD=your-password
SMTP_FROM=info@quailbreeder.net
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä–æ–≥–∞ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é JWT —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∑–∞ **30 –¥–Ω–µ–π** –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è. –ß—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å:

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `scripts/check-apple-jwt.js`:
```javascript
const REGENERATE_THRESHOLD_DAYS = 30; // –ò–∑–º–µ–Ω–∏—Ç–µ —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ
```

## Docker-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–µ—Ç–∞–ª–∏

### –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Docker?

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –î–û —Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–∞** - —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ —Ö–æ—Å—Ç-—Å–∏—Å—Ç–µ–º–µ –ø–µ—Ä–µ–¥ `docker build`
2. **`.env` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Ö–æ—Å—Ç–µ** - –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤ Docker-–æ–±—Ä–∞–∑
3. **Stateless –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä** - JWT —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `.env`, –∫–æ—Ç–æ—Ä—ã–π –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –∏–ª–∏ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ ci.sh

```bash
#!/bin/bash
set -e

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ —Ö–æ—Å—Ç–µ)
echo "üîê Checking Apple JWT expiration..."
node scripts/check-apple-jwt.js

# 2. –°–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–∞ (—Å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–º .env)
docker build --no-cache -t blog:latest .

# 3. –î–µ–ø–ª–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker compose up -d --no-deps --force-recreate blog
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏

### –£—Å–ø–µ—à–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (JWT –≤–∞–ª–∏–¥–µ–Ω)
```
üîç Checking Apple JWT expiration...
üìÖ JWT issued: 2024-12-29T00:00:00.000Z
üìÖ JWT expires: 2025-06-29T00:00:00.000Z
‚è±Ô∏è Days until expiry: 150
‚úÖ JWT is valid for 150 more days. No action needed.
```

### –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è JWT
```
üîç Checking Apple JWT expiration...
üìÖ JWT issued: 2024-07-01T00:00:00.000Z
üìÖ JWT expires: 2025-01-15T00:00:00.000Z
‚è±Ô∏è Days until expiry: 25
‚ö†Ô∏è  JWT expires in 25 days (threshold: 30 days)
üîÑ Regenerating JWT...
‚úÖ New JWT generated and saved
‚ö†Ô∏è  Please commit the updated .env file
üìß Sending notification email...
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚ö†Ô∏è **–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á** (`APPLE_CLIENT_SECRET`) –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è
- ‚ö†Ô∏è **JWT —Ç–æ–∫–µ–Ω** –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä—É—á–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- ‚ö†Ô∏è **`.env` —Ñ–∞–π–ª** –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ `.gitignore` (–µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–µ–∫—Ä–µ—Ç—ã)
- ‚úÖ Email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É

## Troubleshooting

### JWT –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
npm install jose nodemailer

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∫—Ä–∏–ø—Ç—É
chmod +x scripts/check-apple-jwt.js

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Ä—É—á–Ω—É—é –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
node scripts/check-apple-jwt.js
```

### Email –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SMTP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ .env
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–∫—Ä–∏–ø—Ç–∞
node scripts/send-jwt-notification.js "2025-01-15T00:00:00Z" "2025-07-15T00:00:00Z"
```

### JWT –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ JWT –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (3 —á–∞—Å—Ç–∏ —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã–µ —Ç–æ—á–∫–∞–º–∏)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `APPLE_CLIENT_SECRET_JWT` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ `.env`

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–æ–±–ª–µ–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-12-29
**–í–µ—Ä—Å–∏—è:** 1.0.0
