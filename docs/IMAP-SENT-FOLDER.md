# IMAP Sent Folder Integration

## –û–±–∑–æ—Ä

–í—Å–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ø–∞–ø–∫—É "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ" (Sent) –Ω–∞ IMAP —Å–µ—Ä–≤–µ—Ä–µ.

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ SMTP
–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–ª—É—á–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ SMTP (–ø–æ—Ä—Ç 587)

### 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ IMAP
–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø–∞–ø–∫—É Sent —á–µ—Ä–µ–∑ IMAP (–ø–æ—Ä—Ç 993)

### 3. –†–µ–∑—É–ª—å—Ç–∞—Ç
–í—ã –º–æ–∂–µ—Ç–µ –≤–∏–¥–µ—Ç—å –≤—Å–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞ –≤ –ø–æ—á—Ç–æ–≤–æ–º –∫–ª–∏–µ–Ω—Ç–µ (Thunderbird, Outlook, –∏ —Ç.–¥.)

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–§–∞–π–ª—ã:**
- `lib/imap-utils.ts` - —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å IMAP
- `lib/email.ts` - –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏

**–§—É–Ω–∫—Ü–∏—è `sendMailAndSaveToSent()`:**
1. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç email —á–µ—Ä–µ–∑ SMTP
2. –§–æ—Ä–º–∏—Ä—É–µ—Ç RAW RFC822 —Å–æ–æ–±—â–µ–Ω–∏–µ
3. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ IMAP —Å–µ—Ä–≤–µ—Ä—É
4. –ò—â–µ—Ç –ø–∞–ø–∫—É Sent (–ø—Ä–æ–±—É–µ—Ç: Sent, INBOX.Sent, [Gmail]/Sent Mail, Sent Items)
5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–∏—Å—å–º–æ —á–µ—Ä–µ–∑ IMAP APPEND

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–∞–ø–∫–∏

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç –ø–∞–ø–∫—É Sent –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –∏–º–µ–Ω–∞–º:
- `Sent` (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è)
- `INBOX.Sent` (–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ IMAP —Å–µ—Ä–≤–µ—Ä—ã)
- `[Gmail]/Sent Mail` (Gmail)
- `Sent Items` (Exchange/Outlook)

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)

```env
# SMTP –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
SMTP_HOST=mailserver
SMTP_PORT=587
SMTP_USER=info@quailbreeder.net
SMTP_PASSWORD=yourpassword

# IMAP –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Sent
IMAP_PORT=993
IMAP_TLS=true
```

**–í–∞–∂–Ω–æ:** IMAP –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ –∂–µ `SMTP_USER` –∏ `SMTP_PASSWORD` –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.

### Docker Configuration

IMAP —Ä–∞–±–æ—Ç–∞–µ—Ç **—Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Docker —Å–µ—Ç–∏**. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:

1. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä `blog` –∏ `mailserver` –≤ –æ–¥–Ω–æ–π Docker —Å–µ—Ç–∏
2. IMAP –ø–æ—Ä—Ç 993 –æ—Ç–∫—Ä—ã—Ç –Ω–∞ mailserver
3. TLS/SSL –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ mailserver

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å

### ‚úÖ Fail-Safe Design

–ï—Å–ª–∏ IMAP —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å:
- Email **–£–ñ–ï –û–¢–ü–†–ê–í–õ–ï–ù** –ø–æ–ª—É—á–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ SMTP
- –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è, –Ω–æ **–Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å**
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π / —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ

```typescript
try {
  await saveToSentFolder(rawMessage, imapConfig)
} catch (error) {
  console.error('[Email] Failed to save to Sent folder:', error)
  // Email —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, IMAP - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
}
```

### üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è TLS –¥–ª—è IMAP –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- `rejectUnauthorized: false` —Ç–æ–ª—å–∫–æ –¥–ª—è self-signed —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ docker-mailserver
- –¢–µ –∂–µ —É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —á—Ç–æ –∏ –¥–ª—è SMTP

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç IMAP –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

```bash
node scripts/test-imap.js
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–≤ Docker —Å–µ—Ç–∏):**
```
‚úÖ IMAP connection successful!
üìÅ Listing mailboxes...
‚úÖ Found Sent folder: "Sent"
   Messages: 5
   Recent: 0
üéâ IMAP setup is correct!
```

**–í–Ω–µ Docker —Å–µ—Ç–∏:**
```
‚ùå IMAP connection error: getaddrinfo EAI_AGAIN mailserver
```
–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ! IMAP —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ø–æ—á—Ç–æ–≤–æ–º –∫–ª–∏–µ–Ω—Ç–µ

1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ `info@quailbreeder.net` —á–µ—Ä–µ–∑ IMAP
2. –û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–ø–∫—É "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ"
3. –í—Å–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç–∞–º

## Email –∫–æ—Ç–æ—Ä—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

‚úÖ **–°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Sent:**
- Support ticket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ –∞–¥–º–∏–Ω—É)
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
- Apple JWT —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

## Troubleshooting

### –ü–∏—Å—å–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–æ –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ Sent

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**

1. **IMAP –ø–æ—Ä—Ç –æ—Ç–∫—Ä—ã—Ç –Ω–∞ mailserver:**
   ```bash
   docker exec mailserver netstat -tulpn | grep 993
   ```

2. **–õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**
   ```bash
   docker logs blog | grep IMAP
   ```

3. **–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –ø–∞–ø–∫–∏ Sent:**
   ```bash
   node scripts/test-imap.js
   ```

4. **Docker —Å–µ—Ç—å:**
   ```bash
   docker network inspect mailserver_default
   # –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ blog –∏ mailserver –≤ –æ–¥–Ω–æ–π —Å–µ—Ç–∏
   ```

### "Could not find Sent folder"

–ï—Å–ª–∏ –≤–∞—à mailserver –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥—Ä—É–≥–æ–µ –∏–º—è –¥–ª—è –ø–∞–ø–∫–∏ Sent, –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ `lib/imap-utils.ts`:

```typescript
const sentFolderNames = [
  'Sent',
  'INBOX.Sent',
  '[Gmail]/Sent Mail',
  'Sent Items',
  'YOUR_CUSTOM_NAME', // –î–æ–±–∞–≤—å—Ç–µ –∑–¥–µ—Å—å
]
```

### IMAP timeout

–£–≤–µ–ª–∏—á—å—Ç–µ timeout –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ IMAP:

```typescript
const imap = new Imap({
  // ...
  connTimeout: 10000,  // 10 —Å–µ–∫—É–Ω–¥
  authTimeout: 5000,   // 5 —Å–µ–∫—É–Ω–¥
})
```

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

–ï—Å–ª–∏ IMAP –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –µ—Å—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:

### 1. BCC –Ω–∞ —Å–µ–±—è (–ø—Ä–æ—Å—Ç–æ–µ)
```typescript
mailOptions.bcc = 'info@quailbreeder.net'
```
–ú–∏–Ω—É—Å: –ø–∏—Å—å–º–∞ –ø–æ–ø–∞–¥—É—Ç –≤–æ –í—Ö–æ–¥—è—â–∏–µ, –Ω–µ –≤ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ mailserver (—Å–µ—Ä–≤–µ—Ä–Ω–∞—è)
–ù–∞—Å—Ç—Ä–æ–π—Ç–µ docker-mailserver –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞ –≤ Sent –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### 3. –û—Ç–∫–ª—é—á–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
–ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –≤—ã–∑–æ–≤—ã `saveToSentFolder()` –≤ `lib/email.ts`

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**Overhead:**
- SMTP –æ—Ç–ø—Ä–∞–≤–∫–∞: ~100-300ms
- IMAP —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: ~200-500ms
- **–ò—Ç–æ–≥–æ:** ~300-800ms –Ω–∞ email

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ IMAP –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å –±–ª–∞–≥–æ–¥–∞—Ä—è async/await –∏ try/catch.

---

**–í–µ—Ä—Å–∏—è:** 1.0.0
**–î–∞—Ç–∞:** 2025-12-30
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ production
