# Rate limiting for site locations
# Add these inside the existing location blocks in /etc/nginx/sites-available/default

# For location / block:
    # Rate limit for general pages
    limit_req zone=general burst=20 nodelay;
    # Max 20 connections per IP
    limit_conn addr 20;

# For static assets (add new location block BEFORE location /):
    location ~* \.(jpg|jpeg|png|gif|webp|ico|svg|css|js|woff|woff2|ttf|eot|json|xml)$ {
        # Rate limit for static files (more permissive)
        limit_req zone=static burst=100 nodelay;
        limit_conn addr 50;

        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Cache static assets
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

# For API endpoints (if you have /api/* routes):
    location /api/ {
        # Strict rate limit for API
        limit_req zone=api burst=10 nodelay;
        limit_conn addr 10;

        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
