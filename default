##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# https://www.nginx.com/resources/wiki/start/
# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
# https://wiki.debian.org/Nginx/DirectoryStructure
#
# In most cases, administrators will remove this file from sites-enabled/ and
# leave it as reference inside of sites-available where it will continue to be
# updated by the nginx packaging team.
#
# This file will automatically load configuration files provided by other
# applications, such as Drupal or Wordpress. These applications will be made
# available underneath a path with that package name, such as /drupal8.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

# Default server configuration
#
server {
	listen 80 default_server;
	listen [::]:80 default_server;

	server_name _;

	# Redirect all HTTP traffic to HTTPS quailbreeder.net
	# This catches requests by IP (http://217.154.208.217) or unknown domains
	return 301 https://quailbreeder.net$request_uri;
}

server {
	# SSL configuration
    # HTTPS with HTTP/2 only (HTTP/3 disabled - incompatible with Next.js proxy)
    # listen 443 quic reuseport;  # HTTP/3 DISABLED - causes 400 errors
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;

    # HTTP/3 Alt-Svc header (disabled)
    # add_header Alt-Svc 'h3=":443"; ma=86400' always;
    ssl_certificate /etc/letsencrypt/live/quailbreeder.net/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/quailbreeder.net/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    # QUIC 0-RTT (disabled)
    # ssl_early_data on;

    # Proxy buffering optimization for Next.js large images (323KB webp)
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 512k;  # 8 buffers Ã— 512KB = 4MB total (enough for large images)
    proxy_busy_buffers_size 1m;
    proxy_max_temp_file_size 0;  # Disable temp files, use only RAM buffers

    server_name quailbreeder.net; # managed by Certbot


	# Block common exploit/scanner paths
	location ~* ^/(\+CSCOE\+|vpns?|dana-na|remote|citrix|cgi-bin|\.env|\.git) {
		return 444;  # Close connection without response
	}

	# Next.js 16 Turbopack HMR WebSocket - specific location before general /_next/
	# IMPORTANT: WebSocket requires HTTP/1.1, disable HTTP/2 for this endpoint
	location = /_next/webpack-hmr {
		# Force HTTP/1.1 by proxying to backend
		proxy_pass http://localhost:3000;
		proxy_http_version 1.1;

		# WebSocket upgrade headers
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection $connection_upgrade;

		# Standard proxy headers
		proxy_set_header Host $http_host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;

		# Long timeout for persistent WebSocket connection
		proxy_read_timeout 86400s;
		proxy_send_timeout 86400s;

		# Disable buffering for real-time updates
		proxy_buffering off;
	}

	# Next.js internal paths (_next/image, _next/static, etc.) - no rate limit
	location ^~ /_next/ {
		proxy_pass http://localhost:3000;
		proxy_http_version 1.1;
		proxy_set_header Host $http_host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;

		# Increase timeout for image optimization (Next.js can be slow)
		proxy_read_timeout 120s;
		proxy_connect_timeout 120s;
		proxy_send_timeout 120s;

		# Cache Next.js static assets (optimized images, JS, CSS)
		expires 1y;
		add_header Cache-Control "public, immutable";
	}

	# pgAdmin - Database Administration Tool
	# Use ^~ to prevent regex locations from matching pgadmin paths
	location ^~ /pgadmin/ {
		# Basic auth or IP restriction recommended for production!
		# auth_basic "pgAdmin Access";
		# auth_basic_user_file /etc/nginx/.htpasswd;

		# IMPORTANT: No trailing slash in proxy_pass to preserve /pgadmin/ prefix
		proxy_pass http://localhost:5050;
		proxy_http_version 1.1;

		# Required headers for pgAdmin
		proxy_set_header Host $http_host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Script-Name /pgadmin;

		# Increase timeouts for long-running queries
		proxy_read_timeout 300s;
		proxy_connect_timeout 300s;
		proxy_send_timeout 300s;

		# WebSocket support for pgAdmin real-time features
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection $connection_upgrade;

		# Disable buffering for real-time query results
		proxy_buffering off;
		proxy_request_buffering off;
	}

	# Static assets with higher rate limits
	location ~* \.(jpg|jpeg|png|gif|webp|ico|svg|css|js|woff|woff2|ttf|eot|json|xml)$ {
		# Rate limit for static files (more permissive)
		limit_req zone=static burst=100 nodelay;
		# NO connection limit - would conflict with WebSocket

		proxy_pass http://localhost:3000;
		proxy_http_version 1.1;
		proxy_set_header Host $http_host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;

		# Cache static assets (1 year - recommended by PageSpeed for immutable resources)
		expires 1y;
		add_header Cache-Control "public, immutable";
	}

	location / {
		# Rate limit for general pages (requests per second, not connections)
		limit_req zone=general burst=100 nodelay;
		# NO connection limit here - would affect WebSocket paths
		# WebSocket paths have their own connection limits (250)

			# Add custom header for performance testing bot detection (for Next.js middleware)
			# SEO bots (Googlebot, Bingbot, etc.) are NOT marked as bots - they need to index all languages
			set $is_bot 0;
			if ($http_user_agent ~* "PageSpeed|lighthouse|gtmetrix|pingdom") {
				set $is_bot 1;
			}

			# First attempt to serve request as file, then
			# as directory, then fall back to displaying a 404.
			                 #try_files $uri $uri/ =404;
			proxy_pass http://localhost:3000/;
			proxy_http_version 1.1;
			proxy_set_header Host $http_host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header X-Is-Bot $is_bot;
			# Don't send Connection: upgrade for normal HTTP requests
			# proxy_set_header Connection "";
	}
}

server {
    if ($host = quailbreeder.net) {
        return 301 https://$host$request_uri;
    } # managed by Certbot
	listen 80 ;
	listen [::]:80 ;
    server_name quailbreeder.net;
    return 404; # managed by Certbot
}

server {
    server_name www.quailbreeder.net;
    listen 443 ssl; # managed by Certbot
	listen [::]:443 ssl;
	http2 on;
	ssl_certificate /etc/letsencrypt/live/quailbreeder.net/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/quailbreeder.net/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
    return 301 https://quailbreeder.net$request_uri;
}

server {
    server_name www.quailbreeder.net;
    listen 80;
    listen [::]:80;
    # Direct redirect to HTTPS non-www (avoid double redirect)
    return 301 https://quailbreeder.net$request_uri;
}

server {
    if ($host = moment.quailbreeder.net) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    if ($host = karavansky.quailbreeder.net) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    if ($host = app.quailbreeder.net) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

	listen 80 ;
	listen [::]:80 ;
    server_name moment.quailbreeder.net karavansky.quailbreeder.net app.quailbreeder.net;
    return 404; # managed by Certbot
}

# ===============================================
# SUBDOMAIN CONFIGURATION
# ===============================================

# ===== APP SERVER (must be BEFORE redirect block) =====
# HTTP/2 ENABLED to fix Safari 421 Misdirected Request (must match main domain)
server {
    server_name app.quailbreeder.net;
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    ssl_certificate /etc/letsencrypt/live/quailbreeder.net/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/quailbreeder.net/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Safari 421 fix: prevent connection reuse from other domains
    add_header Alt-Svc 'clear' always;

    # Safari 421 fix: use separate SSL session cache for app subdomain
    # Note: ssl_session_tickets is already off in options-ssl-nginx.conf
    ssl_session_cache shared:SSL_APP:10m;

    # Proxy buffering optimization for Next.js large images
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 512k;
    proxy_busy_buffers_size 1m;
    proxy_max_temp_file_size 0;

    # Block common exploit/scanner paths
    location ~* ^/(\+CSCOE\+|vpns?|dana-na|remote|citrix|cgi-bin|\.env|\.git) {
        return 444;
    }

    # Next.js 16 Turbopack HMR WebSocket - specific location before general /_next/
    # IMPORTANT: WebSocket requires HTTP/1.1, disable HTTP/2 for this endpoint
    location = /_next/webpack-hmr {
        # Force HTTP/1.1 by proxying to backend
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;

        # WebSocket upgrade headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # Standard proxy headers
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Long timeout for persistent WebSocket connection
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;

        # Disable buffering for real-time updates
        proxy_buffering off;
    }

    # Next.js internal paths (_next/image, _next/static, etc.) - no rate limit
    location ^~ /_next/ {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Increase timeout for image optimization (Next.js can be slow)
        proxy_read_timeout 120s;
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;

        # Cache Next.js static assets (optimized images, JS, CSS)
        # expires 1y;
        # add_header Cache-Control "public, immutable";
    }

    # Block indexing for app subdomain - return robots.txt
    location = /robots.txt {
        return 200 "User-agent: *\nDisallow: /\n";
        add_header Content-Type text/plain;
    }

    # Static assets with higher rate limits
    location ~* \.(jpg|jpeg|png|gif|webp|ico|svg|css|js|woff|woff2|ttf|eot|json|xml)$ {
        limit_req zone=static burst=100 nodelay;
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location / {
        limit_req zone=general burst=100 nodelay;
        proxy_pass http://localhost:3001/;
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# ===== DEV SERVER =====
# HTTP/2 ENABLED for dev
server {
    server_name dev.moment-lbs.app;
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    ssl_certificate /etc/letsencrypt/live/moment-lbs.app/fullchain.pem; # Placeholder until expanded
    ssl_certificate_key /etc/letsencrypt/live/moment-lbs.app/privkey.pem; # Placeholder until expanded
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Safari 421 fix: prevent connection reuse from other domains
    add_header Alt-Svc 'clear' always;

    # Safari 421 fix: use separate SSL session cache for dev subdomain
    ssl_session_cache shared:SSL_DEV:10m;

    # Proxy buffering optimization for Next.js large images
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 512k;
    proxy_busy_buffers_size 1m;
    proxy_max_temp_file_size 0;

    # Block common exploit/scanner paths
    location ~* ^/(\+CSCOE\+|vpns?|dana-na|remote|citrix|cgi-bin|\.env|\.git) {
        return 444;
    }

    # Next.js 16 Turbopack HMR WebSocket - specific location before general /_next/
    # IMPORTANT: WebSocket requires HTTP/1.1, disable HTTP/2 for this endpoint
    location = /_next/webpack-hmr {
        # Force HTTP/1.1 by proxying to backend
        proxy_pass http://localhost:3007;
        proxy_http_version 1.1;

        # WebSocket upgrade headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # Standard proxy headers
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Long timeout for persistent WebSocket connection
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;

        # Disable buffering for real-time updates
        proxy_buffering off;
    }

    # Next.js internal paths (_next/image, _next/static, etc.) - no rate limit
    location ^~ /_next/ {
        proxy_pass http://localhost:3007;
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Increase timeout for image optimization (Next.js can be slow)
        proxy_read_timeout 120s;
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;

        # Cache Next.js static assets (optimized images, JS, CSS)
        # expires 1y;
        # add_header Cache-Control "public, immutable";
    }

    # Block indexing for dev subdomain - return robots.txt
    location = /robots.txt {
        return 200 "User-agent: *\nDisallow: /\n";
        add_header Content-Type text/plain;
    }

    # Static assets with higher rate limits
    location ~* \.(jpg|jpeg|png|gif|webp|ico|svg|css|js|woff|woff2|ttf|eot|json|xml)$ {
        limit_req zone=static burst=100 nodelay;
        proxy_pass http://localhost:3007;
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location / {
        limit_req zone=general burst=100 nodelay;
        proxy_pass http://localhost:3007/;
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# ===== MOMENT SERVER =====
server {
    server_name moment-lbs.app;
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    ssl_certificate /etc/letsencrypt/live/moment-lbs.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/moment-lbs.app/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Safari 421 fix: prevent connection reuse from other domains
    add_header Alt-Svc 'clear' always;

    # Safari 421 fix: use separate SSL session cache for moment subdomain
    ssl_session_cache shared:SSL_MOMENT:10m;

    # Proxy buffering optimization for Next.js large images
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 512k;
    proxy_busy_buffers_size 1m;
    proxy_max_temp_file_size 0;

    # Block common exploit/scanner paths
    location ~* ^/(\+CSCOE\+|vpns?|dana-na|remote|citrix|cgi-bin|\.env|\.git) {
        return 444;
    }

    # Next.js 16 Turbopack HMR WebSocket - specific location before general /_next/
    location = /_next/webpack-hmr {
        proxy_pass http://localhost:3002;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
        proxy_buffering off;
    }

    # Next.js internal paths
    location ^~ /_next/ {
        proxy_pass http://localhost:3002;
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 120s;
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
    }

    # Block indexing for moment subdomain - return robots.txt
    location = /robots.txt {
        return 200 "User-agent: *\nDisallow: /\n";
        add_header Content-Type text/plain;
    }

    # Static assets
    location ~* \.(jpg|jpeg|png|gif|webp|ico|svg|css|js|woff|woff2|ttf|eot|json|xml)$ {
        limit_req zone=static burst=100 nodelay;
        proxy_pass http://localhost:3002;
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location / {
        limit_req zone=general burst=100 nodelay;
        proxy_pass http://localhost:3002/;
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# ===== REDIRECT SUBDOMAINS TO MAIN DOMAIN =====
server {
    server_name karavansky.moment-lbs.app;
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    ssl_certificate /etc/letsencrypt/live/moment-lbs.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/moment-lbs.app/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    return 301 https://moment-lbs.app$request_uri;
}

# ===== MAIL SUBDOMAIN (Placeholder for SSL) =====
server {
    server_name mail.moment-lbs.app;
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    ssl_certificate /etc/letsencrypt/live/moment-lbs.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/moment-lbs.app/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        return 200 "Mail server is running on non-HTTP ports.";
        add_header Content-Type text/plain;
    }
}

# ===== WEBSOCKET SERVER =====
server {
    server_name ws.moment-lbs.app;
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    ssl_certificate /etc/letsencrypt/live/moment-lbs.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/moment-lbs.app/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Block indexing for ws subdomain
    location = /robots.txt {
        return 200 "User-agent: *\nDisallow: /\n";
        add_header Content-Type text/plain;
    }

    location / {
        limit_conn addr 1000;
        proxy_pass http://localhost:3003/;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_connect_timeout 60s;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# ===== HTTP REDIRECTS (Port 80) =====
server {
    if ($host = moment-lbs.app) {
        return 301 https://$host$request_uri;
    }
    if ($host = ws.moment-lbs.app) {
        return 301 https://$host$request_uri;
    }
    if ($host = mail.moment-lbs.app) {
        return 301 https://$host$request_uri;
    }
    if ($host = karavansky.moment-lbs.app) {
        return 301 https://$host$request_uri;
    }
    if ($host = dev.moment-lbs.app) {
        return 301 https://$host$request_uri;
    }

    listen 80;
    listen [::]:80;
    server_name moment-lbs.app ws.moment-lbs.app mail.moment-lbs.app karavansky.moment-lbs.app dev.moment-lbs.app;
    return 404;
}
