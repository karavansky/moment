# ===============================================
# CORRECT SUBDOMAIN CONFIGURATION
# ===============================================
# Add these server blocks to /etc/nginx/sites-available/default
# AFTER deleting the two incorrect blocks (see instructions below)

# ===== REDIRECT SUBDOMAINS TO MAIN DOMAIN =====
server {
    server_name karavansky.quailbreeder.net moment.quailbreeder.net monitor.quailbreeder.net;
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    ssl_certificate /etc/letsencrypt/live/quailbreeder.net/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/quailbreeder.net/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    return 301 https://quailbreeder.net$request_uri;
}

# ===== WEBSOCKET SERVER =====
server {
    server_name ws.quailbreeder.net;
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    ssl_certificate /etc/letsencrypt/live/quailbreeder.net/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/quailbreeder.net/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        limit_conn addr 1000;
        proxy_pass http://localhost:3003/;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_connect_timeout 60s;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# ===== APP SERVER =====
server {
    server_name app.quailbreeder.net;
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    ssl_certificate /etc/letsencrypt/live/quailbreeder.net/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/quailbreeder.net/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 512k;
    proxy_busy_buffers_size 1m;

    location / {
        limit_req zone=general burst=20 nodelay;
        proxy_pass http://localhost:3001/;
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# ===============================================
# INSTRUCTIONS:
# ===============================================
#
# 1. Backup current config:
#    sudo cp /etc/nginx/sites-available/default /etc/nginx/sites-available/default.backup
#
# 2. Edit /etc/nginx/sites-available/default:
#    sudo nano /etc/nginx/sites-available/default
#
# 3. DELETE these TWO incorrect server blocks:
#
#    Block 1 (~lines 290-374):
#    Starts with: server {
#    Contains: server_name moment.quailbreeder.net karavansky.quailbreeder.net app.quailbreeder.net;
#    Delete from "server {" to the closing "}"
#
#    Block 2 (~lines 411-491):
#    Starts with: server {
#    Contains: server_name ws.quailbreeder.net monitor.quailbreeder.net;
#    Delete from "server {" to the closing "}"
#
# 4. COPY the content from this file (lines 7-72 above)
#    and PASTE it at the END of /etc/nginx/sites-available/default
#    (before the very last closing brace)
#
# 5. Test configuration:
#    sudo nginx -t
#
# 6. If test passes, reload Nginx:
#    sudo systemctl reload nginx
#
# 7. Test each subdomain:
#    curl -I https://karavansky.quailbreeder.net  # Should redirect to main
#    curl -I https://moment.quailbreeder.net      # Should redirect to main
#    curl -I https://monitor.quailbreeder.net     # Should redirect to main
#    curl -I https://ws.quailbreeder.net          # Should connect to WebSocket
#    curl -I https://app.quailbreeder.net         # Should proxy to port 3001
#
